# UDP 上位机图像传输系统

[![Python](https://img.shields.io/badge/Python-3.11+-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

一个用于STM32等嵌入式设备与上位机进行UDP图像传输和日志记录的完整解决方案，支持实时视频显示、数据监控、自定义协议解析等功能。

> **✨ 最新更新**: 已修复CSV读取问题，支持完整记录保存和读取，确保与ImageProcess完美配合。

## 📋 目录

- [功能特性](#功能特性)
- [系统架构](#系统架构)
- [快速开始](#快速开始)
- [安装说明](#安装说明)
- [使用指南](#使用指南)
- [协议格式](#协议格式)
- [自定义帧格式](#自定义帧格式)
- [开发与测试](#开发与测试)
- [项目结构](#项目结构)
- [技术栈](#技术栈)
- [许可证](#许可证)

## ✨ 功能特性

### 🎥 实时视频显示
- **内嵌显示**: 视频直接显示在主窗口中，无需弹出新窗口
- **自动缩放**: 保持宽高比，最大4倍缩放
- **实时统计**: 显示帧率、帧计数、图像尺寸等信息
- **画质保持**: 支持灰度、二值图像显示

### 📊 数据监控
- **实时日志显示**: 在视频下方实时显示自定义日志变量的名称和值
- **原始数据监视器**: 实时显示收到的UDP数据包
- **多编码格式**: 支持UTF-8、GBK、GB2312、ASCII、Latin-1、UTF-16、UTF-32、Big5
- **显示格式**: 详细/简洁/仅Hex/仅文本 四种显示模式
- **历史记录**: 保存最近100个数据包
- **CSV自动记录**: 日志变量名称自动作为CSV列标题，便于数据分析

### 🔧 自定义协议支持
- **分离配置**: 图像帧和日志帧可分别配置自定义格式
- **灵活字节序**: 支持大端/小端字节序配置
- **可变字段长度**: H/W字段支持1-4字节配置
- **帧头帧尾**: 支持自定义帧头帧尾识别

### 📁 数据存储
- **PNG序列**: 自动保存图像帧为PNG文件（压缩二值格式）
- **CSV日志**: 记录日志数据和接收时间戳，支持自定义变量
- **帧索引**: 记录每帧的接收时间戳和文件路径
- **数据对齐**: 按时间戳对齐图像帧和日志数据
- **视频合成**: 一键将PNG序列合成为MP4视频
- **数据清理**: 自动清理特殊字符（NULL/EOF），确保CSV完整性

### 🔍 调试工具
- **实时日志显示**: 自定义日志变量配置，实时显示监控数据
  - 支持12种数据类型（uint8/int8/uint16/int16/uint32/int32/float，大端/小端）
  - 自定义显示格式（小数位数、进制、单位等）
  - 日志变量名称自动作为CSV列标题
  - 线程安全的实时更新机制
- **内嵌示波器**: 实时显示UDP数据波形
  - 支持多变量同时监控
  - 每个变量独立颜色标识
  - 相对时间轴显示
  - 可监控字节值或位值
  - 自定义时间窗口和刷新率
- **数据对齐**: 按上位机接收时间戳对齐图像和日志数据
- **测试客户端**: 内置测试数据发送工具

### 🎨 图像格式支持
- **压缩二值(1位)**: 8像素压缩为1字节，MSB优先
- **二值图像(8位)**: 每像素1字节，值为0或255
- **灰度图像**: 标准8位灰度 (0-255)
- **RGB565**: 16位彩色，R(5位)+G(6位)+B(5位)
- **RGB888**: 24位真彩色
- **BGR888**: 24位真彩色(OpenCV格式)
- **RGBA8888**: 32位带透明通道

## 🏗️ 系统架构

```
┌─────────────────┐    UDP    ┌─────────────────┐
│   STM32设备     │◄─────────►│   上位机GUI     │
│                 │           │                 │
│ • 图像采集      │           │ • 实时显示      │
│ • 数据打包      │           │ • 数据解析      │
│ • UDP发送       │           │ • 文件保存      │
└─────────────────┘           └─────────────────┘
                                    │
                                    ▼
                           ┌─────────────────┐
                           │   数据存储      │
                           │                 │
                           │ • PNG图像      │
                           │ • CSV日志      │
                           │ • MP4视频      │
                           └─────────────────┘
```

## 🚀 快速开始

### 5分钟快速上手

#### 步骤1：安装依赖（仅首次）

```bash
# 使用Conda（推荐）
conda env create -f environment.yml
conda activate udp_env

# 或使用pip
pip install -r requirements.txt
```

#### 步骤2：启动程序

```bash
# Windows用户 - 使用启动脚本（推荐）
run_gui.bat

# 或直接运行Python脚本
python src/udp_gui.py
```

#### 步骤3：基本配置

1. **网络设置**
   - IP地址：选择`0.0.0.0`（监听所有接口）
   - 端口：`8080`（默认）

2. **图像格式**
   - 如果使用STM32压缩传输：选择"压缩二值(1位)"
   - 固定尺寸：120×188（根据实际调整）

3. **日志格式**
   - 根据STM32端协议选择标准或自定义格式

#### 步骤4：开始接收

点击"启动监听"按钮即可开始接收数据。

---

### 🔧 常见配置场景

#### 场景1：标准STM32压缩图传

```
图像帧配置:
├─ 启用自定义图像帧: ✅
├─ 帧头: A0FFFFA0
├─ 帧尾: B0B00A0D
├─ 图像格式: 压缩二值(1位)
└─ 固定尺寸: 120×188

日志帧配置:
├─ 启用自定义日志帧: ✅
├─ 帧头: BB66
├─ 帧尾: 0D0A
└─ 数据格式: 纯文本
```

#### 场景2：灰度图传输

```
图像帧配置:
├─ 启用自定义图像帧: ✅
├─ 图像格式: 灰度图(8位)
└─ 固定尺寸: 或动态解析
```

#### 场景3：RGB565彩色图

```
图像帧配置:
├─ 图像格式: RGB565
└─ 动态解析H/W字段
```

---

### 📊 日志变量配置快速示例

#### 监控温度传感器

```
变量名称: 温度
字节位置: 0
数据类型: uint8
显示格式: {value}°C
```

#### 监控电压（浮点数）

```
变量名称: 电压
字节位置: 4
数据类型: float_le
显示格式: {value:.2f}V
```

#### 监控16位速度值

```
变量名称: 速度
字节位置: 8
数据类型: uint16_le
显示格式: {value} RPM
```

## 📦 安装说明

### 依赖环境
- **Python**: 3.11+
- **Conda**: 推荐使用Conda管理环境

### 安装步骤
```bash
# 1. 创建环境
conda env create -f environment.yml

# 2. 激活环境
conda activate smartcar-udp-host

# 3. 验证安装
python -c "import cv2, numpy, matplotlib; print('环境配置成功')"
```

### 可选依赖
```bash
# 如需ttkbootstrap美化界面
pip install ttkbootstrap

# 如需更多图像处理功能
pip install pillow
```

## 📖 使用指南

### 基本操作

#### 1. 网络配置
- **绑定IP**: 选择本机网络接口或使用 `0.0.0.0` 监听所有接口
- **端口**: UDP监听端口，默认5005
- **自动检测**: 系统会自动检测并列出所有可用IP地址

#### 2. 数据存储配置
- **PNG目录**: 图像帧保存路径
- **日志CSV**: 日志数据保存文件
- **帧索引CSV**: 图像帧索引文件

#### 3. 实时监控
- **视频显示**: 右上区域显示实时视频
- **日志显示**: 视频下方显示配置的日志变量
- **数据监视器**: 右下区域显示原始数据包
- **统计信息**: 显示帧率、包计数、错误统计

### 高级功能

#### 实时日志变量配置

**功能说明**:
在"自定义帧 > 日志变量配置"页面可以配置需要监控的日志变量，系统会自动从日志数据包中提取并实时显示。

**配置步骤**:

1. **添加变量**
   - **变量名称**: 输入有意义的名称（如：温度、速度、电压）
   - **字节位置**: 指定在日志数据包中的字节索引（从0开始）
   - **数据类型**: 选择数据类型
     - `uint8`: 无符号8位整数（0-255）
     - `int8`: 有符号8位整数（-128~127）
     - `uint16_le/be`: 16位整数（小端/大端）
     - `int16_le/be`: 有符号16位整数
     - `uint32_le/be`: 32位整数
     - `int32_le/be`: 有符号32位整数
     - `float_le/be`: 浮点数
   - **显示格式**: 使用Python格式化语法
     - `{value}`: 直接显示值
     - `{value:.2f}`: 保留2位小数
     - `0x{value:02X}`: 16进制显示
     - `{value}°C`: 带单位显示
     - `{value}%`: 百分比显示
   - 点击"添加变量"按钮

2. **查看实时数据**
   - 启动监听后，配置的变量会实时显示在视频下方
   - 格式：`变量名: 值`
   - 深色背景，绿色字体，专业监控界面

3. **CSV自动记录**
   - 日志变量名称自动作为CSV列标题
   - CSV格式：`host_recv_iso, log_text_hex, log_text_utf8, 变量1, 变量2, ...`
   - 每次接收日志时自动解析并写入对应列

**配置示例1：STM32传感器数据**
```
下位机数据包: [BB66] [温度-1字节] [湿度-1字节] [速度-2字节小端] [0D0A]

上位机配置:
- 日志帧头: BB66
- 日志帧尾: 0D0A
- 变量1: 名称=温度, 字节=0, 类型=uint8, 格式={value}°C
- 变量2: 名称=湿度, 字节=1, 类型=uint8, 格式={value}%
- 变量3: 名称=速度, 字节=2, 类型=uint16_le, 格式={value}

CSV输出:
host_recv_iso,log_text_hex,log_text_utf8,温度,湿度,速度
2025-10-23 10:30:45.123,19006432,�,25,60,100
2025-10-23 10:30:45.234,1a006933,�,26,61,105
```

**配置示例2：多路电压监测**
```
下位机数据包: [AA55] [0x02] [0x0C] [V1-4字节float] [V2-4字节float] [V3-4字节float]

上位机配置:
- 日志帧头: AA55
- 数据格式: 标准格式
- 变量1: 名称=电压1, 字节=0, 类型=float_le, 格式={value:.2f}V
- 变量2: 名称=电压2, 字节=4, 类型=float_le, 格式={value:.2f}V
- 变量3: 名称=电压3, 字节=8, 类型=float_le, 格式={value:.2f}V

CSV输出:
host_recv_iso,log_text_hex,log_text_utf8,电压1,电压2,电压3
2025-10-23 10:30:45.123,cdcc0c40cdcc1040cdcc1440,...,3.30,3.75,4.20
```

**注意事项**:
- 字节序：STM32默认是小端序（Little Endian），选择对应的 `_le` 类型
- 字节位置：从0开始计数，注意多字节数据的起始位置
- CSV覆盖：修改变量配置后，建议删除旧的CSV文件，重新生成新的表头
- 实时性：日志显示会随UDP数据包实时更新（通常<50ms延迟）

#### 自定义帧格式
支持为图像帧和日志帧分别配置自定义协议：

**图像帧配置**:
- 帧头/帧尾: 十六进制字符串
- 数据格式: 标准格式或自定义格式
- H/W字段: 1-4字节，可选大端/小端

**日志帧配置**:
- 帧头/帧尾: 十六进制字符串
- 数据格式: 标准格式或纯文本格式

#### 编码格式选择
数据监视器支持8种编码格式：
- UTF-8, GBK, GB2312 (中文)
- ASCII, Latin-1 (英文)
- UTF-16, UTF-32, Big5 (多字节)

#### 内嵌示波器功能
在"示波"标签页中实时显示UDP数据波形：

**添加监控变量**:
1. 输入Byte索引 (0-65535)
2. 可选输入Bit索引 (0-7)，留空则监控整个字节
3. 输入变量名（可选，自动生成格式：`Byte[N].Bit[M]`）
4. 点击"添加变量"按钮

**显示特性**:
- 每个变量自动分配颜色（8种颜色循环）
- X轴显示相对系统时间（从开始监听起）
- Y轴显示数值（位值0/1，字节值0-255）
- 可自定义时间窗口（1-60秒）
- 可调整刷新率（1-60 Hz）
- 支持自动缩放或固定范围

**操作按钮**:
- **添加变量**: 添加新的监控变量
- **删除变量**: 删除选中的变量
- **清空变量**: 清空所有监控变量
- **清除数据**: 清空数据缓存，重新开始记录

**示例配置**:
```
Byte[5]        → 监控第5个字节的完整值 (0-255)
Byte[8].Bit[0] → 监控第8个字节的第0位 (0或1)
Byte[10].Bit[7] → 监控第10个字节的第7位 (0或1)
```

## 📡 协议格式

### 标准协议格式

#### 图像帧 (0x01)
```
[0x01][H:1字节][W:1字节][像素数据:H×W字节]
```
- H: 图像高度 (0-255)
- W: 图像宽度 (0-255)
- 像素数据: 灰度值 (0-255)

#### 二值图像帧 (0x03)
```
[0x03][H:1字节][W:1字节][压缩数据]
```
- 压缩格式: 8像素压缩为1字节
- 像素值: 0或1

#### 日志帧 (0x02)
```
[0x02][LEN:1字节][日志内容:LEN字节]
```
- LEN: 日志内容长度
- 日志内容: UTF-8编码文本
- **时间戳**: 由上位机自动记录接收时间（已移除STM32时间戳字段）

> **注意**: 从v2.0版本起，日志帧已移除8字节STM32时间戳字段，统一使用上位机接收时间戳进行数据对齐。详见[时间戳更新说明](时间戳更新说明.md)。

### 自定义协议格式

#### 自定义图像帧
```
[帧头][H:N字节][W:M字节][像素数据][帧尾]
```
- 帧头/帧尾: 可配置的十六进制序列
- H字段: 1-4字节，可选字节序
- W字段: 1-4字节，可选字节序

#### 自定义日志帧
```
[帧头][日志内容][帧尾]
```
或
```
[帧头][0x02][LEN][日志内容][帧尾]
```

## 🔧 开发与测试

### 测试客户端
```bash
# 运行测试客户端
python test_udp_client.py

# 发送测试数据到本机 (端口8080)
# - 灰度图像: 60x120
# - 二值图像: 60x120
# - 日志数据: UTF-8文本
# - 示波器数据: 正弦波、方波、锯齿波、脉冲信号等

# 测试示波器功能
# 1. 启动GUI并开始监听
# 2. 运行测试客户端: python test_udp_client.py
# 3. 在GUI"示波"标签页添加以下变量:
#    - Byte[5]: 正弦波
#    - Byte[6]: 方波
#    - Byte[7]: 锯齿波
#    - Byte[8].Bit[0]: 脉冲信号
#    - Byte[8].Bit[4]: 交替信号
```

### 命令行工具
```bash
# 直接运行UDP监听器
python udp_image_logger.py run --ip 0.0.0.0 --port 5005

# 合成视频
python udp_image_logger.py video --png-dir frames_png --out video.mp4 --fps 30

# 数据对齐
python udp_image_logger.py align --frames-csv frames_index.csv --logs-csv logs.csv --out aligned.csv

# 示波器模式
python udp_image_logger.py scope --ip 0.0.0.0 --port 5005 --index 0 --bit 0
```

### 开发环境
```bash
# 安装开发依赖
pip install -r requirements.txt

# 运行代码检查
python -m py_compile udp_gui.py udp_image_logger.py test_udp_client.py

# 运行单元测试 (如有)
python -m pytest tests/
```

## 📁 项目结构

```
udp/
├── src/                      # 源代码目录
│   ├── udp_gui.py           # 主GUI界面 ⭐
│   └── udp_image_logger.py  # UDP监听和数据处理核心
├── data/                     # 数据文件目录
│   ├── .gitkeep             # Git目录占位
│   ├── frames_png/          # 图像帧保存目录（自动创建）
│   ├── frames_index.csv     # 帧索引文件（自动生成）
│   ├── logs.csv             # 日志数据文件（自动生成）
│   ├── aligned.csv          # 对齐后的数据（align命令）
│   └── *.mp4                # 合成的视频文件
├── scripts/                  # 辅助脚本目录
│   └── run_gui.bat          # Windows启动脚本（旧版）
├── .gitignore               # Git忽略配置
├── environment.yml          # Conda环境配置
├── requirements.txt         # Python依赖
├── run_gui.bat              # 主启动脚本 ⭐
└── README.md                # 项目文档

注：
- ⭐ 标记的是主要文件
- data/ 目录中的数据文件会被 .gitignore 忽略
- 首次运行时会自动创建 frames_png/ 目录
```

### 📂 目录说明

#### src/ - 源代码目录
存放所有Python源代码文件：
- `udp_gui.py` - 主GUI界面，包含所有界面组件
- `udp_image_logger.py` - UDP监听和数据处理核心模块

#### data/ - 数据文件目录
存放所有运行时产生的数据文件：
- `frames_png/` - 接收到的图像帧（PNG格式）
- `frames_index.csv` - 帧索引记录
- `logs.csv` - 日志数据记录
- `aligned.csv` - 图像和日志对齐后的数据
- `*.mp4` - 合成的视频文件

**注意**: 此目录中的数据文件会被`.gitignore`忽略，不会提交到Git仓库。

#### scripts/ - 辅助脚本目录
存放各种辅助脚本和工具：
- `run_gui.bat` - 旧版启动脚本（保留用于兼容）

### 💡 使用注意事项

1. **首次运行**: 程序会自动在`data/`目录下创建`frames_png/`文件夹
2. **数据保存**: 所有数据文件都保存在`data/`目录中
3. **清理数据**: 可以安全删除`data/`目录中的文件而不影响程序运行
4. **Git管理**: `data/`目录中的数据文件不会被Git跟踪

## 🛠️ 技术栈

### 核心技术
- **Python 3.11+**: 主编程语言
- **OpenCV**: 图像处理和显示
- **NumPy**: 数值计算
- **Socket**: UDP网络通信
- **Tkinter/ttkbootstrap**: GUI界面

### 依赖库
- **opencv-python**: 图像处理
- **numpy**: 数组操作
- **matplotlib**: 示波器绘图
- **Pillow**: 图像格式转换
- **ttkbootstrap**: 现代化GUI样式 (可选)

### 开发工具
- **Conda**: 环境管理
- **Git**: 版本控制
- **VS Code**: 推荐IDE

## 📄 大端序 vs 小端序

在自定义帧格式中，H/W字段支持大端序和小端序配置：

### 大端序 (Big-endian)
- 高位字节存储在低地址
- 示例: 数字 `0x12345678` 存储为 `12 34 56 78`
- 网络字节序标准

### 小端序 (Little-endian)
- 低位字节存储在低地址
- 示例: 数字 `0x12345678` 存储为 `78 56 34 12`
- x86/ARM等处理器常用

### 图像尺寸示例
对于64x48的图像 (H=0x40, W=0x30):

**大端序**:
- H: `00 40` (2字节)
- W: `00 30` (2字节)

**小端序**:
- H: `40 00` (2字节)
- W: `30 00` (2字节)

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 开发规范
1. 遵循 PEP 8 代码风格
2. 添加必要的注释和文档字符串
3. 提交前进行测试验证
4. 更新相关文档

## 📞 支持与故障排除

### 常见问题

**Q1: ImageProcess只加载部分CSV记录？**
- **原因**: 旧版本可能写入了NULL(0x00)或EOF(0x1A)特殊字符
- **解决**: 更新到v2.2版本，删除旧的CSV文件，重新采集数据
- **检查**: PowerShell运行 `Format-Hex logs.csv | Select-String '1A|00'` 检查特殊字符

**Q2: aligned.csv缺少自定义变量？**
- **原因**: 需要使用最新的对齐功能
- **解决**: 使用命令 `python udp_image_logger.py align --frames-csv frames_index.csv --logs-csv logs.csv --out aligned.csv`

**Q3: UDP视频出现横向黑线？**
- **原因**: 可能是SPI速率过高（8Mbps）或WiFi模块缓冲区溢出
- **解决**: 降低STM32 SPI波特率至4Mbps或2Mbps，或增加`delay_us()`至100-150us

**Q4: 日志变量显示不正确？**
- **检查**: 确认字节位置和数据类型配置正确
- **字节序**: STM32默认小端序，选择`*_le`类型
- **测试**: 使用`test_udp_client.py`发送测试数据验证

### 问题4：程序启动失败

**检查**:
- Python版本是否3.11+
- 依赖是否完整安装

**解决**:
```bash
python --version
pip install -r requirements.txt
```

### 问题5：无法接收数据

**检查**:
- IP地址和端口是否正确
- STM32是否成功发送
- 防火墙是否允许UDP通信

**解决**:
- 使用`0.0.0.0`监听所有接口
- 检查STM32代码
- 临时关闭防火墙测试

### 问题6：图像显示错乱

**检查**:
- 图像格式配置是否匹配STM32
- 帧头帧尾是否正确
- 固定尺寸是否正确

**解决**:
- 参考STM32代码确认格式
- 使用原始数据监视器查看实际数据
- 逐步调试帧格式

### 获取帮助

如有其他问题或建议，请：
1. 查看[使用指南](#使用指南)和[常见问题](#常见问题)
2. 提交 [GitHub Issue](https://github.com/Dengdxx/udp/issues)
3. 附上错误信息和测试数据

## � 图像格式详解

上位机支持多种图像数据编码格式，可通过GUI界面的"自定义帧 > 图像帧配置"选择。

### 支持的图像格式

#### 1. 压缩二值(1位) ⭐推荐用于STM32
- **压缩比**: 8:1
- **数据量**: H×W÷8 字节
- **特点**: 8个像素压缩成1字节，MSB优先
- **适用**: TR_Write_Image_Pixle() 函数
- **示例** (60×120图像):
  ```
  帧头: A0FFFFA0 (4字节)
  数据: 900字节 (60×120÷8)
  帧尾: B0B00A0D (4字节)
  总计: 908字节
  ```

#### 2. 二值图(8位)
- **数据量**: H×W 字节
- **特点**: 每像素1字节，自动阈值化(>127为白，否则为黑)
- **示例** (60×120): 7200字节

#### 3. 灰度图(8位)
- **数据量**: H×W 字节
- **特点**: 每像素1字节，0-255灰度值
- **示例** (60×120): 7200字节

#### 4. RGB565
- **数据量**: H×W×2 字节
- **特点**: 5位R + 6位G + 5位B，小端序
- **适用**: 彩色LCD显示屏数据
- **示例** (60×120): 14400字节

#### 5. RGB888
- **数据量**: H×W×3 字节
- **特点**: 标准RGB真彩色
- **示例** (60×120): 21600字节

#### 6. BGR888
- **数据量**: H×W×3 字节
- **特点**: OpenCV默认格式(B-G-R顺序)
- **示例** (60×120): 21600字节

#### 7. RGBA8888
- **数据量**: H×W×4 字节
- **特点**: 带透明通道(Alpha通道会被忽略)
- **示例** (60×120): 28800字节

### 数据大小对比

| 格式 | 60×120图像 | 压缩比 | 适用场景 |
|------|-----------|--------|---------|
| 压缩二值(1位) | 900字节 | 8:1 | 二值图像(推荐) |
| 二值图(8位) | 7200字节 | 1:1 | 简单黑白图 |
| 灰度图(8位) | 7200字节 | 1:1 | 灰度图像 |
| RGB565 | 14400字节 | 1:2 | 彩色图像 |
| RGB888 | 21600字节 | 1:3 | 高质量彩色 |

### STM32代码示例

#### 发送压缩二值图像
```c
// 使用TR_Write_Image_Pixle函数(已实现压缩格式)
void TR_Write_Image_Pixle(unsigned char height, unsigned char width, unsigned char *Pixle)
{
    // ... (使用您的代码)
}

// 使用方法
uint8_t image[60*120];
// 填充image数据...
TR_Write_Image_Pixle(60, 120, image);
```

#### 发送RGB565图像
```c
void Send_RGB565_Image(uint16_t *rgb565_data, uint8_t h, uint8_t w)
{
    uint8_t header[] = {0xAA, 0x55};  // 帧头
    uint8_t size_data[] = {h, w};      // H, W
    
    UDP_Send(header, 2);
    UDP_Send(size_data, 2);
    UDP_Send((uint8_t*)rgb565_data, h * w * 2);
}
```

## ⏱️ 时间戳说明

### 统一时间基准

本系统已简化为**仅使用上位机时间戳**，不再需要STM32提供时间戳。

### 主要变化

#### CSV格式
**logs.csv**
- 旧格式: `stm32_ts_us, host_recv_iso, log_text_hex, log_text_utf8`
- ✅ 新格式: `host_recv_iso, log_text_hex, log_text_utf8`

**frames_index.csv**
- 旧格式: `frame_id, stm32_ts_us, host_recv_iso, png_path, h, w`
- ✅ 新格式: `frame_id, host_recv_iso, png_path, h, w`

#### 日志帧格式
- 旧格式: `[0x02][LEN][时间戳8字节][日志内容]`
- ✅ 新格式: `[0x02][LEN][日志内容]`

### 优势
1. **简化STM32代码**: 无需维护时间戳，减少代码复杂度
2. **统一时间基准**: 所有数据使用上位机时间，便于对齐和分析
3. **减少数据量**: 日志帧减少8字节，节省带宽
4. **降低同步难度**: 无需关心下位机时间戳溢出等问题

### STM32日志代码示例

#### 标准格式
```c
void Send_Log(const char* msg) {
    uint8_t len = strlen(msg);
    uint8_t packet[256];
    
    packet[0] = 0x02;  // LOG类型
    packet[1] = len;   // 长度
    memcpy(&packet[2], msg, len);  // 日志内容（无需时间戳！）
    
    UDP_Send(packet, 2 + len);
}
```

#### 纯文本（更简单）
```c
void Send_Simple_Log(const char* msg) {
    UDP_Send((uint8_t*)msg, strlen(msg));
}
```

### 迁移建议

如果您的旧代码中包含时间戳：

1. **删除时间戳相关代码**
   - 删除DWT初始化
   - 删除时间戳打包代码

2. **更新日志发送函数**
   - 移除8字节时间戳字段
   - 调整数据包长度计算

3. **清空旧CSV文件**
   - 删除或重命名 `logs.csv`
   - 删除或重命名 `frames_index.csv`
   - 新运行会自动创建新格式的CSV

## 📊 示波器功能详解

### 核心功能

#### 1. 多变量监控
- 同时监控多个变量
- 每个变量独立颜色标识
- 支持最多8个变量同时显示（颜色循环使用）

#### 2. 灵活的数据选择
- **监控整个字节**: 显示0-255的完整数值
- **监控单个位**: 显示0或1的二进制值
- **任意字节索引**: UDP数据包中的任意位置

#### 3. 实时显示
- 相对时间轴（从开始监听计时）
- 可配置时间窗口（1-60秒）
- 可调整刷新率（1-60 Hz）
- 自动缩放或固定Y轴范围

### 使用步骤

#### 第一步：启动监听
1. 打开UDP上位机GUI
2. 配置IP和端口（默认8080）
3. 点击"启动监听"按钮

#### 第二步：添加监控变量

**监控整个字节**
```
Byte索引: 5
Bit索引:  (留空)
变量名:   温度传感器
```
→ 监控UDP包第5个字节的完整值(0-255)

**监控单个位**
```
Byte索引: 8
Bit索引:  0
变量名:   电机状态
```
→ 监控UDP包第8个字节的第0位(0或1)

#### 第三步：配置显示
- **时间窗口**: 设置显示最近N秒的数据
- **刷新率**: 设置图表更新频率
- **自动缩放**: 勾选则Y轴自动适应数据范围

### 使用场景示例

#### 场景1：监控传感器数据
```python
# STM32发送数据包格式:
# [Header][Type][Data...]
# Data[0]: 温度 (0-100°C)
# Data[1]: 湿度 (0-100%)
# Data[2]: 压力高字节
# Data[3]: 压力低字节

# 监控配置:
Byte[5]  → 温度
Byte[6]  → 湿度
Byte[7]  → 压力高字节
```

#### 场景2：监控状态标志
```python
# STM32发送状态字节:
# Data[10] = 0bXXXXXXXX
#   Bit[0]: 电机使能
#   Bit[1]: LED状态
#   Bit[2]: 传感器就绪
#   Bit[3]: 错误标志

# 监控配置:
Byte[10].Bit[0] → 电机使能
Byte[10].Bit[1] → LED状态
Byte[10].Bit[2] → 传感器就绪
Byte[10].Bit[3] → 错误标志
```

#### 场景3：监控PWM占空比
```python
# STM32发送PWM数据:
# Data[20]: 左电机PWM (0-255)
# Data[21]: 右电机PWM (0-255)

# 监控配置:
Byte[20] → 左电机PWM
Byte[21] → 右电机PWM
```

### 测试示波器功能

运行 `test_udp_client.py` 会发送包含以下测试信号的数据:

```python
Byte[5]        → 正弦波 (0-255)
Byte[6]        → 方波 (0/255)
Byte[7]        → 锯齿波 (0-255)
Byte[8].Bit[0] → 脉冲信号 (0/1)
Byte[8].Bit[4] → 交替信号 (0/1)
```

**测试步骤**:
1. 启动GUI并点击"启动监听"
2. 切换到"示波"标签页
3. 添加上述5个监控变量
4. 运行 `python test_udp_client.py`
5. 观察波形图显示

### 颜色方案

默认使用8种颜色循环:
1. 🔴 红色 `#FF6B6B`
2. 🔵 青色 `#4ECDC4`
3. 🟡 黄色 `#FFD93D`
4. 🟣 紫色 `#A66FFF`
5. 🟢 绿色 `#6BCF7F`
6. 🟠 橙色 `#FF9F43`
7. 🔷 蓝色 `#4A90E2`
8. 🌸 粉色 `#FF6FA3`

### 注意事项

1. **字节索引范围**: 0 到 UDP数据包长度-1，超出范围不会提取数据
2. **位索引范围**: 0-7，Bit[0]是最低位，Bit[7]是最高位
3. **性能考虑**: 高刷新率(>30Hz)可能占用较多CPU
4. **数据来源**: 示波器从**原始UDP数据包**中提取数据，不依赖帧类型解析

## 🔄 版本历史

### v2.3 (2025-10-24)
- 📁 重组项目目录结构
  - 分离源代码和数据文件（src/, data/, scripts/）
  - 添加`.gitignore`配置，排除数据文件
  - 更新启动脚本和文档
- 📝 整合所有文档到单一README

### v2.2
- 🐛 修复CSV数据完整性问题
  - 添加`sanitize_csv_text()`函数，自动清理特殊字符（NULL/EOF/控制字符）
  - 修复CSV读取中断问题，确保所有记录完整保存
  - 完善`udp_gui.py`和`udp_image_logger.py`的日志帧处理
  - 与ImageProcess无缝配合，支持完整数据流程
- 🔧 优化数据对齐功能
  - `align_frames_and_logs()`保留所有自定义日志变量
  - aligned.csv包含完整的时间戳和变量信息

### v2.1
- ✨ 新增实时日志变量显示功能
  - 自定义日志变量配置（名称、字节位置、数据类型、显示格式）
  - 实时显示在视频下方，专业监控界面
  - 日志变量名称自动作为CSV列标题
  - 支持12种数据类型（uint8/int8/uint16/int16/uint32/int32/float，大端/小端）
  - 线程安全的实时更新机制

### v2.0
- ✨ 新增内嵌示波器功能
  - 多变量实时监控
  - 独立颜色标识
  - 相对时间轴
  - 可监控字节/位值
- ✨ 支持7种图像格式解码
- 🔧 默认端口改为8080
- 🗑️ 移除STM32时间戳，统一使用主机时间戳
- 📝 优化日志帧协议（移除8字节时间戳字段）

### v1.0
- ✅ 基础UDP图像传输
- ✅ 日志数据记录
- ✅ 自定义帧格式支持
- ✅ PNG保存与视频合成

## 🔗 相关项目

- **[ImageProcess](https://github.com/Dengdxx/ImageProcess)**: 配套的图像处理和分析工具
  - 智能CSV读取，支持任意列顺序
  - 可拖动的窗口布局（三图像区域）
  - 平铺帧选择器（1400x900大窗口）
  - Binary模式读取，容错特殊字符
  - 完美支持本项目生成的所有CSV格式

### 完整工作流程

```
STM32设备              UDP上位机           ImageProcess
   ↓                      ↓                    ↓
图像+日志  ─UDP传输→  实时显示         ←CSV导入─  数据分析
   ↓                      ↓                    ↓
压缩二值              PNG保存              帧选择
   ↓                      ↓                    ↓
日志变量            CSV记录              变量分析
```

---

**最后更新**: 2025年10月24日
**版本**: v2.2</content>
<parameter name="filePath">c:\Users\28693\Desktop\Smart-Car-dx\udp\README.md