# UDP 上位机图像传输系统

[![Python](https://img.shields.io/badge/Python-3.11+-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

一个用于STM32等嵌入式设备与上位机进行UDP图像传输和日志记录的完整解决方案，支持实时视频显示、数据监控、自定义协议解析等功能。

## 📋 目录

- [功能特性](#功能特性)
- [系统架构](#系统架构)
- [快速开始](#快速开始)
- [安装说明](#安装说明)
- [使用指南](#使用指南)
- [协议格式](#协议格式)
- [自定义帧格式](#自定义帧格式)
- [开发与测试](#开发与测试)
- [项目结构](#项目结构)
- [技术栈](#技术栈)
- [许可证](#许可证)

## ✨ 功能特性

### 🎥 实时视频显示
- **内嵌显示**: 视频直接显示在主窗口中，无需弹出新窗口
- **自动缩放**: 保持宽高比，最大4倍缩放
- **实时统计**: 显示帧率、帧计数、图像尺寸等信息
- **画质保持**: 支持灰度、二值图像显示

### 📊 数据监控
- **原始数据监视器**: 实时显示收到的UDP数据包
- **多编码格式**: 支持UTF-8、GBK、GB2312、ASCII、Latin-1、UTF-16、UTF-32、Big5
- **显示格式**: 详细/简洁/仅Hex/仅文本 四种显示模式
- **历史记录**: 保存最近100个数据包

### 🔧 自定义协议支持
- **分离配置**: 图像帧和日志帧可分别配置自定义格式
- **灵活字节序**: 支持大端/小端字节序配置
- **可变字段长度**: H/W字段支持1-4字节配置
- **帧头帧尾**: 支持自定义帧头帧尾识别

### 📁 数据存储
- **PNG序列**: 自动保存图像帧为PNG文件
- **CSV日志**: 记录日志数据和时间戳
- **帧索引**: 记录每帧的时间戳和文件路径
- **视频合成**: 一键将PNG序列合成为MP4视频

### 🔍 调试工具
- **示波器功能**: 实时显示日志数据波形
- **数据对齐**: 按时间戳对齐图像和日志数据
- **测试客户端**: 内置测试数据发送工具

## 🏗️ 系统架构

```
┌─────────────────┐    UDP    ┌─────────────────┐
│   STM32设备     │◄─────────►│   上位机GUI     │
│                 │           │                 │
│ • 图像采集      │           │ • 实时显示      │
│ • 数据打包      │           │ • 数据解析      │
│ • UDP发送       │           │ • 文件保存      │
└─────────────────┘           └─────────────────┘
                                    │
                                    ▼
                           ┌─────────────────┐
                           │   数据存储      │
                           │                 │
                           │ • PNG图像      │
                           │ • CSV日志      │
                           │ • MP4视频      │
                           └─────────────────┘
```

## 🚀 快速开始

### 1. 环境准备
```bash
# 克隆项目
git clone https://github.com/Dengdxx/udp.git
cd udp

# 创建Conda环境
conda env create -f environment.yml
conda activate smartcar-udp-host
```

### 2. 启动GUI
```bash
# Windows
run_gui.bat

# 或直接运行
python udp_gui.py
```

### 3. 配置网络
- **IP地址**: 选择监听的网络接口（推荐 `0.0.0.0`）
- **端口**: 默认5005，可自定义
- **协议格式**: 根据STM32端配置选择标准或自定义格式

### 4. 开始监听
点击"启动监听"按钮，开始接收STM32发送的数据。

## 📦 安装说明

### 依赖环境
- **Python**: 3.11+
- **Conda**: 推荐使用Conda管理环境

### 安装步骤
```bash
# 1. 创建环境
conda env create -f environment.yml

# 2. 激活环境
conda activate smartcar-udp-host

# 3. 验证安装
python -c "import cv2, numpy, matplotlib; print('环境配置成功')"
```

### 可选依赖
```bash
# 如需ttkbootstrap美化界面
pip install ttkbootstrap

# 如需更多图像处理功能
pip install pillow
```

## 📖 使用指南

### 基本操作

#### 1. 网络配置
- **绑定IP**: 选择本机网络接口或使用 `0.0.0.0` 监听所有接口
- **端口**: UDP监听端口，默认5005
- **自动检测**: 系统会自动检测并列出所有可用IP地址

#### 2. 数据存储配置
- **PNG目录**: 图像帧保存路径
- **日志CSV**: 日志数据保存文件
- **帧索引CSV**: 图像帧索引文件

#### 3. 实时监控
- **视频显示**: 右上区域显示实时视频
- **数据监视器**: 右下区域显示原始数据包
- **统计信息**: 显示帧率、包计数、错误统计

### 高级功能

#### 自定义帧格式
支持为图像帧和日志帧分别配置自定义协议：

**图像帧配置**:
- 帧头/帧尾: 十六进制字符串
- 数据格式: 标准格式或自定义格式
- H/W字段: 1-4字节，可选大端/小端

**日志帧配置**:
- 帧头/帧尾: 十六进制字符串
- 数据格式: 标准格式（含时间戳）或纯文本格式

#### 编码格式选择
数据监视器支持8种编码格式：
- UTF-8, GBK, GB2312 (中文)
- ASCII, Latin-1 (英文)
- UTF-16, UTF-32, Big5 (多字节)

#### 示波器功能
实时显示日志数据的波形图：
- 指定字节索引
- 可选位索引（0-7）
- 最大显示点数可配置

## 📡 协议格式

### 标准协议格式

#### 图像帧 (0x01)
```
[0x01][H:1字节][W:1字节][像素数据:H×W字节]
```
- H: 图像高度 (0-255)
- W: 图像宽度 (0-255)
- 像素数据: 灰度值 (0-255)

#### 二值图像帧 (0x03)
```
[0x03][H:1字节][W:1字节][压缩数据]
```
- 压缩格式: 8像素压缩为1字节
- 像素值: 0或1

#### 日志帧 (0x02)
```
[0x02][LEN:1字节][时间戳:8字节][日志内容:LEN字节]
```
- LEN: 日志内容长度
- 时间戳: 64位微秒值 (小端序)
- 日志内容: UTF-8编码文本

### 自定义协议格式

#### 自定义图像帧
```
[帧头][H:N字节][W:M字节][像素数据][帧尾]
```
- 帧头/帧尾: 可配置的十六进制序列
- H字段: 1-4字节，可选字节序
- W字段: 1-4字节，可选字节序

#### 自定义日志帧
```
[帧头][日志内容][帧尾]
```
或
```
[帧头][0x02][LEN][时间戳][日志内容][帧尾]
```

## 🔧 开发与测试

### 测试客户端
```bash
# 运行测试客户端
python test_udp_client.py

# 发送测试数据到本机
# - 灰度图像: 60x120
# - 二值图像: 60x120
# - 日志数据: 带时间戳
```

### 命令行工具
```bash
# 直接运行UDP监听器
python udp_image_logger.py run --ip 0.0.0.0 --port 5005

# 合成视频
python udp_image_logger.py video --png-dir frames_png --out video.mp4 --fps 30

# 数据对齐
python udp_image_logger.py align --frames-csv frames_index.csv --logs-csv logs.csv --out aligned.csv

# 示波器模式
python udp_image_logger.py scope --ip 0.0.0.0 --port 5005 --index 0 --bit 0
```

### 开发环境
```bash
# 安装开发依赖
pip install -r requirements.txt

# 运行代码检查
python -m py_compile udp_gui.py udp_image_logger.py test_udp_client.py

# 运行单元测试 (如有)
python -m pytest tests/
```

## 📁 项目结构

```
udp/
├── udp_gui.py              # 主GUI界面
├── udp_image_logger.py     # UDP监听和数据处理核心
├── test_udp_client.py      # 测试数据发送客户端
├── run_gui.bat            # Windows启动脚本
├── environment.yml        # Conda环境配置
├── requirements.txt       # Python依赖
├── frames_png/           # 图像帧保存目录
├── frames_index.csv      # 帧索引文件
├── logs.csv              # 日志数据文件
└── README.md             # 项目文档
```

## 🛠️ 技术栈

### 核心技术
- **Python 3.11+**: 主编程语言
- **OpenCV**: 图像处理和显示
- **NumPy**: 数值计算
- **Socket**: UDP网络通信
- **Tkinter/ttkbootstrap**: GUI界面

### 依赖库
- **opencv-python**: 图像处理
- **numpy**: 数组操作
- **matplotlib**: 示波器绘图
- **Pillow**: 图像格式转换
- **ttkbootstrap**: 现代化GUI样式 (可选)

### 开发工具
- **Conda**: 环境管理
- **Git**: 版本控制
- **VS Code**: 推荐IDE

## 📄 大端序 vs 小端序

在自定义帧格式中，H/W字段支持大端序和小端序配置：

### 大端序 (Big-endian)
- 高位字节存储在低地址
- 示例: 数字 `0x12345678` 存储为 `12 34 56 78`
- 网络字节序标准

### 小端序 (Little-endian)
- 低位字节存储在低地址
- 示例: 数字 `0x12345678` 存储为 `78 56 34 12`
- x86/ARM等处理器常用

### 图像尺寸示例
对于64x48的图像 (H=0x40, W=0x30):

**大端序**:
- H: `00 40` (2字节)
- W: `00 30` (2字节)

**小端序**:
- H: `40 00` (2字节)
- W: `30 00` (2字节)

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 开发规范
1. 遵循 PEP 8 代码风格
2. 添加必要的注释和文档字符串
3. 提交前进行测试验证
4. 更新相关文档

## 📞 支持

如有问题或建议，请：
1. 查看[使用指南](#使用指南)
2. 提交 [GitHub Issue](https://github.com/Dengdxx/udp/issues)
3. 发送测试数据验证问题

---

**最后更新**: 2025年10月23日</content>
<parameter name="filePath">c:\Users\28693\Desktop\Smart-Car-dx\udp\README.md