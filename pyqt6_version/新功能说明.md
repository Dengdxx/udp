# 新功能说明文档

## 📅 更新日期：2025-11-18

---

## 🎨 功能 1：二值图（自定义8位）彩色编码

### 概述
在自定义图像帧中新增 **"二值图(自定义8位)"** 编码格式，支持索引彩色显示。

### 特性说明

| 像素值 | 显示效果 | 说明 |
|--------|---------|------|
| `0` | 黑色 `#000000` | 保持传统黑色 |
| `255` | 白色 `#FFFFFF` | 保持传统白色 |
| `1-254` | 彩色（HSV映射） | 根据数值映射到色轮上的不同颜色 |

### 颜色映射算法
- **色相计算**：`Hue = (value - 1) × 360° / 254`
- **饱和度**：100%（鲜艳色彩）
- **明度**：100%（最大亮度）
- **色轮分布**：
  - `1-42`：红色 → 黄色
  - `43-85`：黄色 → 绿色
  - `86-127`：绿色 → 青色
  - `128-169`：青色 → 蓝色
  - `170-211`：蓝色 → 品红
  - `212-254`：品红 → 红色

### 应用场景

#### 1. 语义分割可视化
```
0   = 背景（黑）
1   = 道路（红）
50  = 车辆（黄绿）
100 = 行人（青）
150 = 建筑（蓝）
200 = 植被（品红）
255 = 未知（白）
```

#### 2. 热力图/深度图
```
1-254 = 温度/深度梯度（彩虹色）
0     = 无效区域
255   = 饱和区域
```

#### 3. 目标跟踪
```
不同 ID 的目标用不同颜色标识
ID % 254 + 1 = 颜色索引
```

### 配置步骤

1. **打开上位机** → 自定义帧标签页
2. **启用自定义图像帧**
3. **配置帧标识**：
   ```
   帧头 (Hex): A0FFFFA0
   帧尾 (Hex): B0B00A0D
   ```
4. **选择编码格式**：**二值图(自定义8位)** ⭐
5. **设置尺寸**：
   ```
   模式: 固定尺寸
   固定高度: 120
   固定宽度: 188
   ```
6. **点击启动监听**

### 数据包格式

```
[帧头: 4 bytes] + [像素数据: H×W bytes] + [帧尾: 4 bytes]
```

**示例**（60×80 图像）：
```
A0FFFFA0 [4800 字节像素数据] B0B00A0D
```

每个像素 1 字节，取值 0-255。

### 测试工具

使用提供的测试脚本：
```bash
python test_new_features.py
```

选择测试模式：
- **模式 1**：动画测试（动态彩色效果）
- **模式 2**：渐变测试（完整色轮展示）

---

## 🎬 功能 2：实时 MP4 录制

### 概述
在"实时视频"显示区域新增 **MP4 实时录制功能**，无需保存中间 PNG 文件。

### 特性说明

✅ **直接录制**：从实时视频流直接写入 MP4  
✅ **零中间文件**：不需要保存 PNG，节省磁盘空间  
✅ **自动适配**：支持灰度图和彩色图  
✅ **智能检测**：自动识别分辨率和颜色格式  
✅ **录制状态提示**：按钮颜色变化 + 状态栏提示  
✅ **一键打开**：录制完成后可直接打开文件位置

### 使用流程

#### 步骤 1：启动监听
1. 配置 UDP 监听参数（IP、端口）
2. 点击 **"启动监听"** 按钮
3. 等待接收到视频帧（"实时视频"区域显示画面）

#### 步骤 2：开始录制
1. 点击 **"⏺ 开始录制"** 按钮（统计信息右侧）
2. 在弹出的对话框中选择保存路径和文件名
   - 默认文件名：`record_YYYYMMDD_HHMMSS.mp4`
3. 确认后开始录制
   - 按钮变为 **"⏹ 停止录制"**（红色）
   - 状态栏显示：`正在录制: /path/to/file.mp4`

#### 步骤 3：停止录制
1. 再次点击 **"⏹ 停止录制"** 按钮
2. 录制完成，自动保存文件
3. 弹出提示框询问是否打开文件位置
   - 点击 **"是"**：自动打开文件所在目录
   - 点击 **"否"**：关闭提示

### 技术参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **帧率** | 30 FPS | 与 UI 刷新同步（33ms 定时器） |
| **编码器** | MP4V | OpenCV VideoWriter 标准编码 |
| **颜色空间** | 自动检测 | 灰度：单通道；彩色：BGR |
| **分辨率** | 自动检测 | 根据首帧尺寸初始化 |
| **文件格式** | MP4 | 通用播放器兼容 |

### UI 按钮状态

| 状态 | 按钮文本 | 按钮颜色 | 说明 |
|------|---------|---------|------|
| 未录制 | ⏺ 开始录制 | 默认蓝色 | 可以点击开始录制 |
| 录制中 | ⏹ 停止录制 | 红色 `#c50f1f` | 正在录制，点击停止 |

### 自动停止场景

以下情况会自动停止录制并保存文件：

1. 用户点击 **"停止监听"** 按钮
2. 用户关闭主窗口
3. UDP 连接异常中断
4. 写入帧失败（磁盘空间不足等）

### 与 PNG 保存的区别

| 对比项 | PNG 保存 | MP4 录制 |
|--------|---------|---------|
| **启用位置** | 运行标签页 | 实时视频区域 |
| **中间文件** | 需要（每帧一个 PNG） | 不需要 |
| **磁盘占用** | 大（未压缩） | 小（视频压缩） |
| **事后处理** | 需要手动合成 | 直接可用 |
| **适用场景** | 逐帧分析、后期处理 | 快速回放、分享展示 |

### 常见问题

#### Q1：录制的 MP4 是否包含音频？
**A**：不包含。当前仅录制视频流，无音频轨道。

#### Q2：录制是否影响 PNG 保存？
**A**：不影响。两者完全独立，可以同时启用。

#### Q3：录制时可以调整帧率吗？
**A**：当前固定为 30 FPS。如需自定义，可在代码中修改 `self.record_fps` 变量。

#### Q4：录制的视频颜色异常？
**A**：检查图像编码格式配置。灰度图和彩色图会自动识别，但确保接收端数据格式正确。

#### Q5：录制文件过大怎么办？
**A**：
- 降低图像分辨率
- 使用灰度图代替彩色图
- 录制较短时长后分段保存
- 使用其他压缩编码器（需修改代码中的 fourcc）

---

## 🔧 代码改动说明

### 修改的文件

#### 1. `config.py`
- 在 `IMAGE_FORMATS` 列表中添加 `'二值图(自定义8位)'`

#### 2. `udp_receiver_qt.py`
- 在 `decode_image_by_format()` 函数中新增分支：
  ```python
  elif format_type == '二值图(自定义8位)':
      # 实现 0/255→黑白，1-254→彩色的映射逻辑
  ```

#### 3. `udp_gui_qt.py`
- 导入 `cv2` 和 `QFileDialog`
- 新增成员变量：
  - `self.is_recording`
  - `self.video_writer`
  - `self.record_output_path`
  - `self.record_fps`
- 新增 UI 组件：
  - `self.record_mp4_btn`（录制按钮）
- 新增方法：
  - `_toggle_mp4_recording()`：切换录制状态
  - `_start_recording_mp4()`：开始录制
  - `_stop_recording_mp4()`：停止录制
- 修改方法：
  - `_update_video_display()`：增加写入 MP4 帧的逻辑
  - `_on_stop_receiver()`：停止监听时自动停止录制
  - `closeEvent()`：关闭窗口时安全释放录制资源

### 依赖项

无需新增依赖，使用现有库：
- `opencv-python`（已有）
- `numpy`（已有）
- `PyQt6`（已有）

---

## 📝 测试清单

### 二值图(自定义8位) 测试

- [ ] 启动 `test_new_features.py` 脚本
- [ ] 上位机配置自定义图像帧（编码格式选择"二值图(自定义8位)"）
- [ ] 验证颜色显示：
  - [ ] 像素值 0 显示黑色
  - [ ] 像素值 255 显示白色
  - [ ] 像素值 1-254 显示渐变彩色
- [ ] 检查彩色映射是否平滑过渡

### MP4 录制功能测试

- [ ] 启动监听并接收视频流
- [ ] 点击"开始录制"按钮
- [ ] 验证按钮状态变化（文本、颜色）
- [ ] 录制 5-10 秒后点击"停止录制"
- [ ] 检查 MP4 文件是否生成
- [ ] 使用播放器播放 MP4 文件
- [ ] 验证视频内容正确（灰度/彩色）
- [ ] 测试停止监听时自动停止录制
- [ ] 测试关闭窗口时安全释放资源

### 兼容性测试

- [ ] 原有编码格式（灰度图、RGB565 等）仍正常工作
- [ ] PNG 保存功能不受影响
- [ ] 示波器、日志功能正常
- [ ] 深色/亮色主题切换正常

---

## 🚀 未来改进方向

### 二值图编码扩展
- [ ] 支持自定义颜色映射表（LUT）
- [ ] 提供预设调色板（彩虹、热力、灰度等）
- [ ] 颜色映射配置界面

### MP4 录制增强
- [ ] 可配置帧率（UI 输入框）
- [ ] 支持更多编码器（H.264、H.265）
- [ ] 录制时显示时长和文件大小
- [ ] 支持暂停/继续录制
- [ ] 音频轨道支持（从麦克风或系统音频）

---

## 📞 技术支持

如有问题或建议，请参考：
- 主文档：`README.md`
- 测试脚本：`test_new_features.py`
- 代码注释：各模块源文件

**版本**：PyQt6 v1.1  
**更新时间**：2025-11-18
